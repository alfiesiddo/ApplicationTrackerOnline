@model List<ApplicationTrackerOnline.Models.JobApplication>
@{
    ViewData["Title"] = "Your Applications";

    var orderedApplications = Model
        .OrderBy(a => a.Status)
        .ThenByDescending(a => a.AppliedDate);
}

<div class="text-center my-4">
    <h1 class="display-4">@ViewData["Title"]</h1>
</div>

<div class="d-flex justify-content-center gap-2 mb-4 flex-wrap">
    <a class="btn btn-dark" asp-controller="Home" asp-action="AddApplication">
        Add Application
    </a>

    <select id="statusFilter" class="form-select" style="width: auto;">
        <option value="all">Show All</option>
        <option value="1">Applied</option>
        <option value="0">Rejected</option>
        <option value="2">Scouted</option>
        <option value="3">Assessments</option>
        <option value="4">Interview</option>
        <option value="5">Offered</option>
    </select>
</div>

@Html.AntiForgeryToken()

<div class="container">
    <div class="row justify-content-center g-4" id="application-list">
        @foreach (var app in orderedApplications)
        {
            <div class="col-12 col-md-10 col-lg-8 d-flex justify-content-center"
                 data-status="@app.Status"
                 data-job-id="@app.Id">
                <div class="w-100" style="max-width: 900px;">
                    @await Html.PartialAsync("_JobApplicationCard", app)
                </div>
            </div>
        }
    </div>
</div>

<div class="modal fade" id="dateInputModal" tabindex="-1" aria-labelledby="dateInputModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dateInputModalLabel">Update Application</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="statusDateForm">
                    <div class="mb-3">
                        <label for="statusDateInput" class="form-label" id="dateInputLabel">Select Date</label>

                        <input type="datetime-local" 
                               class="form-control" 
                               id="statusDateInput" 
                               required
                               style="cursor: pointer; caret-color: transparent;"
                               onclick="try{this.showPicker()}catch(e){}"
                               onfocus="try{this.showPicker()}catch(e){}"
                               onkeydown="return false">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmStatusUpdateBtn">Save Update</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        const STATUS_MAP = {
            1: { label: "Applied", cls: "status-applied" },
            0: { label: "Rejected", cls: "status-rejected" },
            2: { label: "Scouted", cls: "status-scouted" },
            3: { label: "Assessments", cls: "status-assessments" },
            4: { label: "Interview", cls: "status-interview" },
            5: { label: "Offered", cls: "status-offered" }
        };

        // Variables to hold state during modal interaction
        let pendingJobId = null;
        let pendingStatus = null;
        let dateModal = null; // Bootstrap modal instance

        document.addEventListener('DOMContentLoaded', () => {
             // Initialize bootstrap modal
             const modalEl = document.getElementById('dateInputModal');
             if(modalEl && window.bootstrap) {
                 dateModal = new bootstrap.Modal(modalEl);
             }
        });

        function getAntiForgeryToken() {
            const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
            return tokenInput ? tokenInput.value : null;
        }

        async function updateStatusOnServer(jobId, newStatus, dateValue = null) {
            const url = '/Home/UpdateApplicationStatus';
            const token = getAntiForgeryToken();

            // Build Payload
            const payload = {
                id: parseInt(jobId),
                status: parseInt(newStatus, 10),
                date: dateValue 
            };

            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['RequestVerificationToken'] = token;

            const resp = await fetch(url, {
                method: 'POST',
                headers,
                body: JSON.stringify(payload),
                credentials: 'same-origin'
            });

            if (!resp.ok) {
                const text = await resp.text();
                throw new Error(text || `Server responded ${resp.status}`);
            }

            location.reload();
            return await resp.json();
        }

        function handleStatusSelection(jobId, statusValue, toggle, menu, dropdown) {
            // Check if special handling is needed (3 = Assessments, 4 = Interview)
            if (statusValue === "3" || statusValue === "4") {

                // Close the dropdown menu first
                closeMenu(dropdown, toggle, menu);

                // Set pending variables
                pendingJobId = jobId;
                pendingStatus = statusValue;

                // Configure Modal Text
                const modalLabel = document.getElementById('dateInputLabel');
                const modalTitle = document.getElementById('dateInputModalLabel');
                const dateInput = document.getElementById('statusDateInput');

                // Clear previous input
                dateInput.value = '';

                if (statusValue === "3") {
                    modalTitle.textContent = "Assessments Stage";
                    modalLabel.textContent = "When is the Assessment Due?";
                } else {
                    modalTitle.textContent = "Interview Stage";
                    modalLabel.textContent = "When is the Interview?";
                }
                if (dateModal) dateModal.show();
            } else {
                closeMenu(dropdown, toggle, menu);
                updateStatusOnServer(jobId, statusValue);
            }
        }

        //Modal Confirm Button Logic
        const confirmBtn = document.getElementById('confirmStatusUpdateBtn');
        if (confirmBtn) {
            confirmBtn.addEventListener('click', () => {
                const dateInput = document.getElementById('statusDateInput');
                if (!dateInput.value) {
                    alert("Please select a date.");
                    return;
                }

                // Send to server with the date
                updateStatusOnServer(pendingJobId, pendingStatus, dateInput.value)
                    .then(() => {
                        if (dateModal) dateModal.hide();
                    })
                    .catch(err => {
                        console.error(err);
                        alert("Error updating status.");
                    });
            });
        }


        function setBadge(jobId, statusInt) {
            const toggle = document.getElementById('status-toggle-' + jobId);
            const badgeLabel = toggle && toggle.querySelector('.status-label');
            if (!toggle || !badgeLabel) return;
            const map = STATUS_MAP[statusInt] || { label: 'Unknown', cls: 'status-unknown' };
            badgeLabel.textContent = map.label;
            toggle.className = 'status-badge ' + map.cls;
        }

        function openMenu(dropdown, toggle, menu) {
            menu.removeAttribute('hidden');
            toggle.setAttribute('aria-expanded', 'true');
            const current = menu.querySelector('.status-item.current');
            if(current) current.focus();
            else { const f = menu.querySelector('.status-item'); if(f) f.focus(); }

            document.addEventListener('click', dropdown._outsideHandler = (ev) => {
                if (!dropdown.contains(ev.target)) closeMenu(dropdown, toggle, menu);
            });
            document.addEventListener('keydown', dropdown._keyHandler = (ev) => menuKeyHandler(ev, dropdown, toggle, menu));
        }

        function closeMenu(dropdown, toggle, menu) {
            menu.setAttribute('hidden', '');
            toggle.setAttribute('aria-expanded', 'false');
            if (dropdown._outsideHandler) {
                document.removeEventListener('click', dropdown._outsideHandler);
                dropdown._outsideHandler = null;
            }
            if (dropdown._keyHandler) {
                document.removeEventListener('keydown', dropdown._keyHandler);
                dropdown._keyHandler = null;
            }
        }

        function toggleMenu(dropdown, toggle, menu) {
            const isOpen = toggle.getAttribute('aria-expanded') === 'true';
            if (isOpen) closeMenu(dropdown, toggle, menu);
            else openMenu(dropdown, toggle, menu);
        }

        function menuKeyHandler(e, dropdown, toggle, menu) {
            // ... (Keep your existing key handler logic here) ...
            if (e.key === 'Escape') {
                e.preventDefault(); closeMenu(dropdown, toggle, menu); toggle.focus();
            }
        }

        // Attach listeners
        document.querySelectorAll('.status-dropdown').forEach(dropdown => {
            const toggle = dropdown.querySelector('.status-badge');
            const menu = dropdown.querySelector('.status-menu');
            const jobAncestor = dropdown.closest('[data-job-id]');
            const jobId = jobAncestor ? jobAncestor.getAttribute('data-job-id') : null;

            if (!toggle || !menu || !jobId) return;

            toggle.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleMenu(dropdown, toggle, menu);
            });

            menu.querySelectorAll('.status-item').forEach(item => {
                item.addEventListener('click', (ev) => {
                    const selectedValue = item.getAttribute('data-value');

                    handleStatusSelection(jobId, selectedValue, toggle, menu, dropdown);
                });
            });
        });
    })();

    // Filter Script
    document.addEventListener('DOMContentLoaded', function () {
        const statusFilter = document.getElementById('statusFilter');
        const applicationList = document.getElementById('application-list');
        const allApplications = applicationList.querySelectorAll('[data-status]');

        if(statusFilter) {
            statusFilter.addEventListener('change', function () {
                const selectedStatus = this.value;
                allApplications.forEach(function (card) {
                    const cardStatus = card.getAttribute('data-status');
                    if (selectedStatus === 'all' || cardStatus === selectedStatus) {
                        card.classList.remove('d-none');
                    } else {
                        card.classList.add('d-none');
                    }
                });
            });
        }
    });
</script>