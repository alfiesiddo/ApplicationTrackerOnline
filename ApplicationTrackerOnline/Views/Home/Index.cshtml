@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager
@model List<ApplicationTrackerOnline.Models.ApplicationDateDTO>

@{
    ViewData["Title"] = "Dashboard";
}

<div class="text-center">
    <h1 class="display-4">@ViewData["Title"]</h1>
</div>

@if (SignInManager.IsSignedIn(User))
{
    <div>
        <div class="card p-4 mb-4">
            <!-- JS will inject the server-rendered partial into -->
            <div id="applicationStagesContainer">
                Loading application stages...
            </div>
        </div>
        <div class="card p-4 mb-4">
            <h3>Daily Applications (Since Start)</h3>
            <br />
            <canvas id="applicationsChart" height="300"></canvas>
        </div>
        <div class="card p-4 mb-4 d-flex flex-row gap-4">
            <div class="flex-fill status-assessments p-3 rounded border shadow">
                <h3>Assessment Deadlines</h3>
                <div id="assessmentsListContainer"></div>
            </div>
            <div class="flex-fill status-interview p-3 rounded border shadow">
                <h3>Interview Dates</h3>
                <div id="interviewListContainer"></div>
            </div>
        </div>
        <div class="card p-4 mb-4">
            <div class="flex-fill status-scouted p-3 rounded border shadow">
                <h3>List of Jobs To Apply For <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#addJobModal">Add</button></h3>
                <div id="potentialJobsContainer"></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addJobModal" tabindex="-1" aria-labelledby="addJobModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" asp-action="AddPotential" asp-controller="Home" class="needs-validation" novalidate>
                    <div class="modal-header">
                        <h5 class="modal-title" id="addJobModalLabel">Add Job</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <div class="modal-body">
                        @Html.AntiForgeryToken()

                        <div class="mb-3">
                            <label for="EmployerName" class="form-label">Employer name</label>
                            <input name="EmployerName" type="text" class="form-control" id="EmployerName" required />
                            <div class="invalid-feedback">Please enter an employer name.</div>
                        </div>

                        <div class="mb-3">
                            <label for="JobsiteURL" class="form-label">Job site URL</label>
                            <input name="JobsiteURL" type="url" class="form-control" id="JobsiteURL" placeholder="https://example.com" />
                            <div class="invalid-feedback">Please enter a valid URL or leave blank.</div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-dark">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (function () {
          'use strict'
          var forms = document.querySelectorAll('.needs-validation')
          Array.prototype.slice.call(forms).forEach(function(form) {
            form.addEventListener('submit', function (event) {
              if (!form.checkValidity()) {
                event.preventDefault()
                event.stopPropagation()
              }
              form.classList.add('was-validated')
            }, false)
          })
        })();
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            async function loadApplicationStagesPartial() {
                try {
                    const response = await fetch('@Url.Action("GetVaryingStages", "Home")');
                    if (!response.ok) throw new Error('Failed to load partial: ' + response.status);
                    const html = await response.text();
                    document.getElementById('applicationStagesContainer').innerHTML = html;
                } catch (err) {
                    console.error(err);
                    const el = document.getElementById('applicationStagesContainer');
                    if (el) el.innerText = 'Failed to load application stages.';
                }
            }

            loadApplicationStagesPartial();
        });
    </script>
    <script>
        async function loadApplicationsChart() {
            try {
                const response = await fetch('@Url.Action("GetDailyApplicationsChartData", "Home")');
                if (!response.ok) throw new Error('Failed to fetch chart data');

                const chartData = await response.json();
                if (!chartData.length) return;

                // Sort data by date just in case
                chartData.sort((a, b) => new Date(a.date) - new Date(b.date));

                const firstDate = new Date(chartData[0].date);
                const today = new Date();
                
                today.setHours(0, 0, 0, 0);

                const allDates = [];
                for (let d = new Date(firstDate); d <= today; d.setDate(d.getDate() + 1)) {
                    allDates.push(new Date(d));
                }

                // Map API data
                const dataMap = chartData.reduce((acc, item) => {
                    acc[new Date(item.date).toDateString()] = item.count;
                    return acc;
                }, {});

                const labels = allDates.map(d => d.toLocaleDateString());
                const data = allDates.map(d => dataMap[d.toDateString()] || 0);

                const ctx = document.getElementById('applicationsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Applications',
                            data,
                            backgroundColor: 'rgba(134, 0, 243, 0.18)',
                            borderColor: 'rgba(134, 0, 243, 0.8)',
                            borderWidth: 1.5,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 1.5
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true },
                            tooltip: {
                                callbacks: {
                                    label: ctx => `${ctx.raw} applications`
                                }
                            }
                        },
                        scales: {
                            x: { title: { display: true, text: 'Date' } },
                            y: {
                                title: { display: true, text: 'Applications' },
                                beginAtZero: true
                            }
                        }
                    }
                });

            } catch (err) {
                console.error('Chart error:', err);
            }
        }

        loadApplicationsChart();
    </script>


    <script>
        loadInterviews();
        loadAssessments();
        loadPotentialJobs();
        function loadInterviews() {
            fetch('@Url.Action("Interviews", "Home")')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.text();
                })
                .then(html => {
                    document.getElementById('interviewListContainer').innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading interviews:', error);
                    document.getElementById('interviewListContainer').innerHTML = "<p class='text-danger'>Error loading interviews.</p>";
                });
        }

        function loadAssessments() {
            fetch('@Url.Action("Assessments", "Home")')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.text();
                })
                .then(html => {
                    document.getElementById('assessmentsListContainer').innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading assessments:', error);
                    document.getElementById('assessmentsListContainer').innerHTML = "<p class='text-danger'>Error loading assessments.</p>";
                });
        }

        function loadPotentialJobs() {
            fetch('@Url.Action("PotentialApplications", "Home")')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.text();
                })
                .then(html => {
                    document.getElementById('potentialJobsContainer').innerHTML = html;
                })
                .catch(error => {
                    // Corrected this line: changed the semicolon to a closing parenthesis
                    console.error('Error loading potential jobs:', error);
                    document.getElementById('potentialJobsContainer').innerHTML = "<p class='text-danger'>Error loading potential jobs.</p>";
                });
        }
    </script>
}
else
{   <div class="text-center">
        <p>Please sign in to see and edit your applications.</p>
    </div>
}
