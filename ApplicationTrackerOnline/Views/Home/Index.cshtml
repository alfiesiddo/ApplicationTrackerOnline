@using Microsoft.AspNetCore.Identity
@inject SignInManager<ApplicationUser> SignInManager
@model List<ApplicationTrackerOnline.Models.ApplicationDateDTO>

@{
    ViewData["Title"] = "Dashboard";
}

<div class="text-center">
    <h1 class="display-4">@ViewData["Title"]</h1>
</div>

@if (SignInManager.IsSignedIn(User))
{
    <div>
        <div class="card p-4 mb-4">
            <!-- JS will inject the server-rendered partial into -->
            <div id="applicationStagesContainer">
                Loading application stages...
            </div>
        </div>
        <div class="card p-4 mb-4">
            <h3>Daily Applications (Last 3 Months)</h3>
            <br />
            <canvas id="applicationsChart" height="200"></canvas>
        </div>
        <div class="card p-4 mb-4 d-flex flex-row gap-4">
            <div class="flex-fill status-assessments p-3 rounded border shadow">
                <h3>Assessment Deadlines</h3>
                <div id="assessmentsListContainer"></div>
            </div>
            <div class="flex-fill status-interview p-3 rounded border shadow">
                <h3>Interview Dates</h3>
                <div id="interviewListContainer"></div>
            </div>          
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            async function loadApplicationStagesPartial() {
                try {
                    const response = await fetch('@Url.Action("GetVaryingStages", "Home")');
                    if (!response.ok) throw new Error('Failed to load partial: ' + response.status);
                    const html = await response.text();
                    document.getElementById('applicationStagesContainer').innerHTML = html;
                } catch (err) {
                    console.error(err);
                    const el = document.getElementById('applicationStagesContainer');
                    if (el) el.innerText = 'Failed to load application stages.';
                }
            }

            loadApplicationStagesPartial();
        });
    </script>
    <script> 
        async function loadApplicationsChart() {
            try {
                const response = await fetch('@Url.Action("GetDailyApplicationsChartData", "Home")');
                if (!response.ok) throw new Error('Failed to fetch chart data');

                const chartData = await response.json();

                const today = new Date();
                const startDate = new Date();
                startDate.setMonth(startDate.getMonth() - 3);

                const allDates = [];
                for (let d = new Date(startDate); d <= today; d.setDate(d.getDate() + 1)) {
                    allDates.push(new Date(d));
                }

                const dataMap = chartData.reduce((acc, item) => {
                    acc[new Date(item.date).toDateString()] = item.count;
                    return acc;
                }, {});

                const labels = allDates.map(d => d.toLocaleDateString());
                const data = allDates.map(d => dataMap[d.toDateString()] || 0);

                const ctx = document.getElementById('applicationsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Applications',
                            data: data,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true },
                            tooltip: {
                                callbacks: {
                                    label: function(ctx) { return ctx.raw + ' applications'; }
                                }
                            }
                        },
                        scales: {
                            x: { title: { display: true, text: 'Date' } },
                            y: { title: { display: true, text: 'Applications' }, beginAtZero: true }
                        }
                    }
                });

            } catch (err) {
                console.error('Chart error:', err);
            }
        }

        loadApplicationsChart();
    </script>


    <script>
        document.addEventListener("DOMContentLoaded", function () {
            loadInterviews();
            loadAssessments();
        });

        // --- Function 1: Load Interviews ---
        function loadInterviews() {
            fetch('@Url.Action("Interviews", "Home")')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.text();
                })
                .then(html => {
                    document.getElementById('interviewListContainer').innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading interviews:', error);
                    document.getElementById('interviewListContainer').innerHTML = "<p class='text-danger'>Error loading interviews.</p>";
                });
        }

        // --- Function 2: Load Assessments ---
        function loadAssessments() {
            fetch('@Url.Action("Assessments", "Home")')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.text();
                })
                .then(html => {
                    document.getElementById('assessmentsListContainer').innerHTML = html;
                })
                .catch(error => {
                    console.error('Error loading assessments:', error);

                    document.getElementById('assessmentsListContainer').innerHTML = "<p class='text-danger'>Error loading assessments.</p>";
                });
        }
    </script>
}
else
{   <div class="text-center">
        <p>Please sign in to see and edit your applications.</p>
    </div>
}
